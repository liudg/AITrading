# 🗄️ 数据库设置说明

## ✅ 已完成的工作

### 1. 数据库表结构 (Schema)

所有的数据库表已通过 Prisma 迁移创建完成，包括：

#### 核心业务表

- **models** - AI模型配置表（4条记录）
  - DeepSeek V3
  - Qwen Max
  - Claude 3.5 Sonnet
  - GPT-4

- **portfolios** - 投资组合表（4条记录）
  - 每个AI模型对应一个独立账户
  - 初始资金：$100,000
  - 当前资产范围：$105,000 - $115,000

- **positions** - 持仓表（5条记录）
  - DeepSeek V3: NVDA (50股), TSLA (20股)
  - Qwen Max: AAPL (100股)
  - Claude 3.5 Sonnet: MSFT (30股)
  - GPT-4: GOOGL (150股)

- **portfolio_snapshots** - 投资组合历史快照（292条记录）
  - 过去72小时的资产变化曲线
  - 用于前端图表展示

- **trades** - 交易记录表（7条记录）
  - 包含买入和卖出交易
  - 包含已平仓交易（用于测试反思功能）
  - 每笔交易都有详细的AI决策理由
  - 记录交易状态：PENDING/EXECUTED/CLOSED

- **reflections** - 反思记录表（1条记录）
  - 对已平仓交易的AI反思
  - 包含经验教训和评分

#### 战报相关表

- **daily_reports** - 每日战报表
  - Day 编号（Day 1, Day 2...）
  - 战报日期、标题、摘要
  - 整体市场洞察

- **report_model_performances** - 模型表现详情表
  - 绩效指标：总资产、收益率、当日收益
  - 持仓统计：持仓数量、现金比例、仓位比例
  - 排名追踪：排名变化
  - 交易统计：交易次数、胜率
  - 今日交易列表
  - 最佳/最差交易ID

- **report_stock_distributions** - 持仓分布表
  - 股票代码
  - 持有AI数量
  - 总持股数、总市值、总浮盈浮亏
  - 持有者列表（JSON）
  - 变化列表（建仓/清仓，JSON）

#### 数据支持表

- **stock_pools** - 股票池表（1条记录）
  - AI & Tech Stocks 2024
  - 包含10支科技股：NVDA, TSLA, AAPL, MSFT, GOOGL, META, AMZN, AMD, NFLX, BABA

- **market_data** - 市场数据表（310条记录）
  - 10支股票的过去31天历史数据
  - 包含：开盘价、最高价、最低价、收盘价、成交量

- **news_data** - 新闻数据表（10条记录）
  - 针对各个股票的最新新闻
  - 包含情绪分析（POSITIVE/NEGATIVE/NEUTRAL）
  - 涵盖全市场新闻

- **system_config** - 系统配置表（4条记录）
  - trading_enabled: 交易开关
  - trading_interval: 交易间隔（4小时）
  - max_position_size: 单只股票最大仓位（20%）
  - max_total_position: 总仓位上限（80%）

### 2. API接口覆盖

所有后端API接口都已验证，可以正常访问数据：

#### 模型管理接口
- `GET /api/models` - 获取所有AI模型
- `POST /api/models` - 创建新模型
- `GET /api/models/:modelId` - 获取单个模型详情

#### 投资组合接口
- `GET /api/portfolio/:modelId` - 获取投资组合状态
- `GET /api/portfolio/:modelId/history` - 获取投资组合历史

#### 交易记录接口
- `GET /api/trades` - 获取交易记录（支持筛选）
- `GET /api/trades/:tradeId` - 获取单笔交易详情

#### 反思记录接口
- `GET /api/reflections` - 获取反思记录
- `GET /api/reflections/:modelId` - 获取指定模型的反思记录

#### 战报接口
- `GET /api/reports` - 获取战报列表
- `GET /api/reports/:reportId` - 获取战报详情（通过ID）
- `GET /api/reports/day/:day` - 获取战报详情（通过Day编号）
- `POST /api/reports/generate` - 手动生成战报

#### 选股接口
- `POST /api/stock-picker` - AI选股
- `POST /api/stock-pool` - 保存股票池
- `GET /api/stock-pool` - 获取活跃股票池

#### 市场数据接口
- `GET /api/market-data/:symbol` - 获取市场数据

#### 新闻数据接口
- `GET /api/news` - 获取新闻数据
- `GET /api/news/:symbol` - 获取指定股票的新闻

#### 系统状态接口
- `GET /api/status` - 获取系统状态
- `GET /health` - 健康检查

### 3. 测试数据特点

#### 真实感数据
- 所有股价基于真实市场价格范围
- 交易决策带有真实的AI理由
- 新闻数据反映当前科技行业热点

#### 多样性
- 4个不同的AI模型，展示不同的交易策略
- 收益率从5%到15%不等，展示性能差异
- 包含成功和失败的交易案例
- 包含不同类型的交易状态（执行中、已平仓）

#### 完整性
- 从模型创建 → 投资组合初始化 → 交易执行 → 持仓管理 → 资产快照 → 反思学习 → 战报生成
- 完整覆盖整个交易生命周期

### 4. 数据统计

```
📊 数据库内容统计：
├─ AI模型: 4个
├─ 投资组合: 4个
├─ 持仓记录: 5条
├─ 投资组合快照: 292条 (72小时历史)
├─ 交易记录: 7条 (包含买入/卖出/已平仓)
├─ 反思记录: 1条
├─ 每日战报: 0条 (需手动生成)
├─ 模型表现详情: 0条
├─ 持仓分布记录: 0条
├─ 股票池: 1个 (10支股票)
├─ 市场数据: 310条 (10支股票 × 31天)
├─ 新闻数据: 10条
└─ 系统配置: 4条
```

## 🚀 启动应用程序

### 方式1：标准启动流程

```bash
# 1. 安装依赖
cd server
npm install

# 2. 生成 Prisma Client
npm run prisma:generate

# 3. 运行数据库迁移
npm run prisma:migrate

# 4. 填充基础种子数据
npm run prisma:seed

# 5. 生成测试战报（可选）
npm run test:report

# 6. 启动后端服务
npm run dev

# 7. 新终端启动前端
cd ../client
npm install
npm run dev
```

### 方式2：快速重置数据库

```bash
cd server

# 重置数据库（会清空所有数据）
npx prisma migrate reset

# 填充种子数据
npm run prisma:seed

# 生成测试战报
npm run test:report
npm run test:report  # 可多次运行生成多天数据
```

## 🌐 访问地址

- **前端界面**: http://localhost:5173
- **后端API**: http://localhost:3000/api
- **Prisma Studio**: http://localhost:5555 (运行 `npm run prisma:studio`)
- **健康检查**: http://localhost:3000/health

## 🧪 测试建议

### 1. 测试排行榜页面 (Leaderboard)
访问 `http://localhost:5173/` 
应该能看到：
- ✅ 4个AI模型的卡片
- ✅ 每个模型的收益率、总资产
- ✅ 性能图表（过去72小时）
- ✅ 持仓列表
- ✅ 按收益率排序

### 2. 测试战报列表页面
访问 `http://localhost:5173/reports`
应该能看到：
- ✅ 所有战报列表（按Day倒序）
- ✅ 每份战报的Day编号、日期、标题
- ✅ "生成今日战报"按钮
- ✅ "查看详情"链接

### 3. 测试战报详情页面
访问 `http://localhost:5173/reports/{reportId}`
应该能看到：
- ✅ 顶部快速洞察卡片区
- ✅ 模型表现对比表（含排名变化）
- ✅ 今日交易记录（所有交易 + AI决策理由）
- ✅ 持仓分布（股票维度统计）

### 4. 测试实时页面 (Live)
访问 `http://localhost:5173/live`
应该能看到：
- ✅ 最近的交易记录
- ✅ AI决策理由
- ✅ 股票池信息

### 5. 测试API接口

```bash
# 测试获取所有模型
curl http://localhost:3000/api/models

# 测试获取投资组合
curl http://localhost:3000/api/portfolio/{modelId}

# 测试获取交易记录
curl http://localhost:3000/api/trades

# 测试获取战报列表
curl http://localhost:3000/api/reports

# 测试获取战报详情
curl http://localhost:3000/api/reports/{reportId}

# 测试生成战报
curl -X POST http://localhost:3000/api/reports/generate

# 测试获取新闻
curl http://localhost:3000/api/news

# 测试健康检查
curl http://localhost:3000/health
```

## 📝 数据管理命令

### 基础种子数据

```bash
cd server

# 填充基础数据（清空后重新创建）
npm run prisma:seed

# 输出内容：
# - 4个AI模型
# - 4个投资组合
# - 持仓数据
# - 72小时快照
# - 7条交易记录
# - 1条反思记录
# - 股票池、市场数据、新闻数据
```

### 测试战报数据

```bash
cd server

# 生成一份测试战报（可多次运行）
npm run test:report

# 特点：
# - 每个模型生成3-8笔随机交易
# - 自动计算Day编号
# - 生成完整的战报和持仓分布
# - 显示访问链接
```

### 历史快照数据

```bash
cd server

# 为现有投资组合生成72小时历史快照
npm run seed:history

# 特点：
# - 保留现有数据
# - 只删除并重新生成快照
# - 模拟真实的资产波动
```

### 数据验证

```bash
cd server

# 验证所有表的数据完整性
npm run verify

# 输出内容：
# - 所有表的记录数
# - 战报数据详情
# - 模型表现统计
# - 数据关系检查
```

### 清空并重置数据库

```bash
cd server

# 完全重置数据库
npx prisma migrate reset

# 或手动删除数据库文件
# Windows PowerShell:
Remove-Item prisma/dev.db -ErrorAction SilentlyContinue
# Linux/Mac:
rm -f prisma/dev.db

# 重新运行迁移
npm run prisma:migrate

# 填充数据
npm run prisma:seed
npm run test:report
```

### 查看数据库（可视化）

```bash
cd server

# 启动 Prisma Studio
npm run prisma:studio

# 访问 http://localhost:5555
# 可视化编辑所有表的数据
```

## ⚠️ 注意事项

1. **数据库文件位置**: `server/prisma/dev.db`
2. **环境变量**: 确保 `.env` 文件存在并配置正确
   ```env
   DATABASE_URL="file:./dev.db"
   ```
3. **端口占用**: 确保3000和5173端口未被占用
4. **Node版本**: 建议使用 Node.js 18+
5. **Prisma Client**: 每次修改 schema 后需要运行 `npm run prisma:generate`
6. **数据库迁移**: 使用 `npm run prisma:migrate` 而不是手动修改数据库

## 🎯 界面功能验证清单

### 排行榜页面 (/)
- [ ] 显示4个AI模型卡片
- [ ] 每个卡片显示模型名称和图标
- [ ] 显示当前收益率（彩色标识）
- [ ] 显示总资产和现金
- [ ] 性能图表正常显示（折线图）
- [ ] 持仓列表正常显示
- [ ] 持仓显示股票代码、数量、未实现盈亏
- [ ] 模型按收益率排序

### 战报列表页面 (/reports)
- [ ] 显示所有战报列表
- [ ] 按Day编号倒序排列
- [ ] 显示Day、日期、标题、摘要
- [ ] "生成今日战报"按钮可用
- [ ] "查看详情"链接正常跳转
- [ ] 生成战报后自动跳转到详情页

### 战报详情页面 (/reports/:id)
- [ ] 顶部显示Day编号和日期
- [ ] 快速洞察卡片显示市场概况
- [ ] 模型表现对比表完整显示
- [ ] 排名变化图标正确（🔺🔻↔️）
- [ ] 当日盈亏显示正确
- [ ] 仓位状态标签显示（满仓/空仓/正常）
- [ ] 今日交易记录完整展示
- [ ] 最佳/最差交易有标记
- [ ] AI决策理由可折叠查看
- [ ] 持仓分布表正确统计
- [ ] 建仓/清仓变化正确标注
- [ ] 关键发现内容合理

### 实时交易页面 (/live)
- [ ] 显示当前活跃的股票池
- [ ] 显示最近的交易记录
- [ ] 交易记录显示模型、操作、股票、数量
- [ ] 显示AI决策理由
- [ ] 交易记录按时间倒序排列
- [ ] 区分买入/卖出操作（颜色）

### 导航栏
- [ ] Logo和标题显示正常
- [ ] 页面切换正常
- [ ] 当前页面高亮显示
- [ ] WebSocket连接状态显示

## 🐛 可能的问题和解决方案

### 问题1: 前端显示"No data available"
**原因**: 后端未启动或API连接失败
**解决**: 
```bash
cd server
npm run dev
# 检查 http://localhost:3000/api/status
```

### 问题2: 图表不显示
**原因**: 快照数据不足
**解决**: 
```bash
cd server
npm run prisma:seed  # 重新填充数据
npm run seed:history # 补充历史快照
```

### 问题3: Prisma Client错误
**原因**: 未生成客户端或版本不匹配
**解决**: 
```bash
cd server
npm run prisma:generate
```

### 问题4: 数据库迁移问题
**原因**: Schema与数据库不同步
**解决**: 
```bash
cd server
npx prisma migrate reset
npm run prisma:seed
```

### 问题5: 战报列表为空
**原因**: 未生成战报数据
**解决**: 
```bash
cd server
npm run test:report
# 或在前端点击"生成今日战报"按钮
```

### 问题6: 战报详情页面数据不完整
**原因**: 可能缺少交易数据或持仓数据
**解决**: 
```bash
cd server
npm run prisma:seed  # 重新填充基础数据
npm run test:report  # 重新生成战报
```

### 问题7: TypeScript编译错误
**原因**: Prisma Client 类型未更新
**解决**: 
```bash
cd server
npm run prisma:generate
npm run build
```

## 📊 数据库ER图

```
Model (AI模型)
  ├─→ Portfolio (1:1) - 投资组合
  │     ├─→ Position (1:N) - 持仓
  │     └─→ PortfolioSnapshot (1:N) - 快照
  ├─→ Trade (1:N) - 交易
  ├─→ Reflection (1:N) - 反思
  └─→ ReportModelPerformance (1:N) - 战报表现

Trade (交易)
  └─→ Reflection (1:1) - 反思

DailyReport (每日战报)
  ├─→ ReportModelPerformance (1:N) - 模型表现
  └─→ ReportStockDistribution (1:N) - 持仓分布

StockPool (股票池) - 独立表

MarketData (市场数据) - 独立表

NewsData (新闻) - 独立表

SystemConfig (系统配置) - 独立表
```

## ✅ 总结

所有数据库表已创建并填充测试数据，API接口全部可用。您现在可以：

1. ✅ 启动应用程序查看界面效果
2. ✅ 测试所有功能是否正常
3. ✅ 生成测试战报进行演示
4. ✅ 根据需要调整数据或添加更多测试数据
5. ✅ 开始开发新功能

### 推荐工作流程

1. **首次启动**：
   ```bash
   npm run prisma:migrate
   npm run prisma:seed
   npm run test:report
   ```

2. **日常开发**：
   ```bash
   npm run dev  # 启动后端
   npm run verify  # 验证数据
   ```

3. **测试战报**：
   ```bash
   npm run test:report  # 生成新的一天
   ```

4. **重置环境**：
   ```bash
   npx prisma migrate reset
   npm run prisma:seed
   npm run test:report
   ```

如有任何问题，请查看：
- 后端日志：终端输出
- 数据库内容：Prisma Studio (http://localhost:5555)
- API响应：浏览器开发者工具
- 详细文档：[测试数据脚本说明.md](./测试数据脚本说明.md)

