# 持仓分布统计功能说明

## 📊 功能概述

在战报详情页新增"持仓分布统计"模块，从**股票视角**展示所有AI的持仓情况，帮助用户了解：
- 哪些股票是"抱团股"（多个AI共同持有）
- 哪些股票表现最好/最差
- 当日持仓的变化（新增、清仓）

---

## 🎯 模块位置

**战报详情页**：在"模型表现对比表"之后，"详细分析"之前

```
战报详情页
├── 快速洞察卡片（4个关键指标）
├── 📊 模型表现对比表
├── 🎯 持仓分布统计 ← 新增
└── 🔍 详细分析
```

---

## 📋 表格内容

### 表头
| 股票代码 | 持有AI数 | 总持股数 | 总盈亏浮动 | 主要持有者 | 变化 |
|---------|---------|---------|-----------|-----------|------|

### 示例数据
| 股票代码 | 持有AI数 | 总持股数 | 总盈亏浮动 | 主要持有者 | 变化 |
|---------|---------|---------|-----------|-----------|------|
| AAPL | 4 | 801股 | +$2,926.00 ✓ | Qwen (500), GPT-4 (180), Grok (86), Claude (35) | 不变 |
| BABA | 2 | 221股 | -$1,233.79 ✗ | Grok (161), Gemini (60) | 🆕 Gemini |
| MSFT | 2 | 40股 | +$239.00 ● | Grok (20), Claude (20) | 不变 |
| AMZN | 2 | 49股 | -$237.89 ✗ | Claude (40), DeepSeek (9) | ❌ Grok清仓 |

---

## 🔍 字段说明

### 1. 股票代码
- 展示所有当前有持仓的股票
- **包括当日已清仓但有交易的股票**

### 2. 持有AI数
- 当前有多少个AI持有这只股票
- **用于识别"抱团"行为**
- **按此字段降序排序**（持有AI最多的在最上面）

### 3. 总持股数
- 所有AI持有的总数量
- 格式：`801股`

### 4. 总盈亏浮动
- 所有AI在这只股票上的**总浮盈浮亏**
- 颜色：
  - 绿色 + ✓：盈利
  - 红色 + ✗：亏损
  - 灰色 + ●：持平或微小波动
- 格式：`+$2,926.00 ✓` 或 `-$1,233.79 ✗`

### 5. 主要持有者
- 列出所有持有该股票的AI及数量
- 格式：`Qwen (500), GPT-4 (180), Grok (86)`
- **全部展示**，不限数量

### 6. 变化
- 对比昨天，今天的持仓变化
- **变化类型**：
  - `🆕 新增`：昨天没人持有，今天有AI买入
  - `❌ XX清仓`：某AI今天清仓了
  - `不变`：持有者与昨天一样

**变化判断逻辑**：
```typescript
// 新增持仓
if (今天有持有 && 昨天没有持有) {
  变化 = "🆕 新增"
}

// 清仓
if (今天没有持有 && 昨天有持有) {
  变化 = "❌ XX清仓"
}

// 不变
if (持有者完全相同) {
  变化 = "不变"
}
```

---

## 💡 关键发现（规则生成）

表格下方自动生成"关键发现"，包括：

### 1. 最大赢家
```
🏆 AAPL成为最大赢家：4个AI持有，总浮盈+$2,926.00
```

### 2. 最大输家
```
📉 BABA成为最大输家：2个AI持有，总浮亏-$1,233.79
```

### 3. 抱团股票
```
🤝 AAPL是"抱团股"：4个AI共同持有，总持股801股
```
**判断条件**：持有AI数 ≥ 4

### 4. 新增持仓
```
🆕 新增持仓：BABA、JD
```

### 5. 完全清仓
```
❌ 完全清仓：NVDA、GOOGL
```
**判断条件**：昨天有人持有，今天所有AI都清仓了

### 6. 部分清仓
```
📤 AMZN部分清仓：Grok退出，2个AI仍持有
```

### 7. 独门股
```
🎯 META是"独门股"：仅Claude持有
```
**判断条件**：只有1个AI持有

---

## 🗂️ 数据库设计

### 新增表：`ReportStockDistribution`

```prisma
model ReportStockDistribution {
  id              String   @id @default(uuid())
  reportId        String
  report          DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  symbol          String   // 股票代码
  holdingAICount  Int      // 持有AI数量
  totalShares     Int      // 总持股数
  totalValue      Float    // 总市值
  totalPnL        Float    // 总浮盈浮亏
  
  holders         String   // JSON: 持有者列表
  changes         String?  // JSON: 变化列表
  
  createdAt       DateTime @default(now())

  @@unique([reportId, symbol])
  @@index([symbol])
  @@map("report_stock_distributions")
}
```

### holders 字段（JSON）
```json
[
  {
    "modelName": "Qwen Max",
    "shares": 500,
    "avgPrice": 268.32,
    "currentPrice": 272.41,
    "pnl": 2043.72
  },
  {
    "modelName": "GPT-4",
    "shares": 180,
    "avgPrice": 269.56,
    "currentPrice": 272.41,
    "pnl": 512.38
  }
]
```

### changes 字段（JSON）
```json
[
  {
    "modelName": "Gemini",
    "action": "NEW"
  },
  {
    "modelName": "Grok",
    "action": "CLOSED"
  }
]
```

---

## 🔄 后端逻辑

### 数据收集流程

```typescript
calculateStockDistributions() {
  // 1. 收集所有股票的持仓情况
  for (每个AI模型) {
    // 当前持仓
    for (每个持仓) {
      stockMap[symbol].holders.push({
        modelName, shares, avgPrice, currentPrice, pnl
      })
    }
    
    // 当日清仓的股票
    for (每笔交易) {
      if (卖出 && 不再持有) {
        stockMap[symbol].clearedToday.add(modelName)
      }
    }
  }
  
  // 2. 获取昨天的持仓分布
  yesterdayReport = getReportByDay(day - 1)
  
  // 3. 计算每只股票的统计数据和变化
  for (每只股票) {
    // 计算总持股数、总盈亏
    totalShares = sum(holders.shares)
    totalPnL = sum(holders.pnl)
    
    // 对比昨天，找出变化
    changes = []
    if (今天有 && 昨天没有) changes.push({ modelName, action: 'NEW' })
    if (今天没有 && 昨天有) changes.push({ modelName, action: 'CLOSED' })
  }
  
  // 4. 按持有AI数量降序排序
  sort by holdingAICount DESC
}
```

---

## 🎨 前端展示

### 表格样式
- **赛博朋克风格**：黑色背景、绿色高亮
- **hover效果**：鼠标悬停时行背景变亮
- **响应式设计**：自适应不同屏幕尺寸

### 盈亏颜色
```typescript
if (totalPnL > 0) {
  color = 'text-cyber-green'  // 绿色
  symbol = '✓'
} else if (totalPnL < 0) {
  color = 'text-cyber-red'    // 红色
  symbol = '✗'
} else {
  color = 'text-gray-400'     // 灰色
  symbol = '●'
}
```

### 变化标签
```vue
<span v-if="change.action === 'NEW'" class="bg-blue-500/20 text-blue-400">
  🆕 {{ change.modelName }}
</span>

<span v-if="change.action === 'CLOSED'" class="bg-red-500/20 text-red-400">
  ❌ {{ change.modelName }}清仓
</span>
```

---

## 🧪 测试场景

### 场景1：抱团股票
```
AAPL: 4个AI持有
→ 识别为"抱团股"
→ 关键发现："AAPL是'抱团股'：4个AI共同持有"
```

### 场景2：新增持仓
```
Day 9: BABA 没人持有
Day 10: Gemini 买入 BABA
→ 变化："🆕 Gemini"
→ 关键发现："新增持仓：BABA"
```

### 场景3：完全清仓
```
Day 9: NVDA 被 Claude, Grok 持有
Day 10: Claude, Grok 都卖出
→ holdingAICount = 0
→ 关键发现："完全清仓：NVDA"
```

### 场景4：部分清仓
```
Day 9: AMZN 被 Grok, Claude, DeepSeek 持有
Day 10: Grok 卖出
→ 变化："❌ Grok清仓"
→ 关键发现："AMZN部分清仓：Grok退出，2个AI仍持有"
```

### 场景5：独门股
```
META: 只有Claude持有
→ 关键发现："META是'独门股'：仅Claude持有"
```

---

## 📊 实际应用场景

### 1. 发现市场共识
- 看到4个AI都持有AAPL
- → AAPL可能是强势股
- → 市场共识度高

### 2. 识别逆向机会
- 某股票被多个AI清仓
- → 可能存在问题
- → 或者是超卖机会

### 3. 观察策略差异
- 某股票只有1个AI持有
- → 该AI有独特见解
- → 值得关注其理由

### 4. 追踪热点切换
- 昨天的抱团股今天被清仓
- → 热点切换
- → 市场风格转变

---

## 🔄 对比优势

### 相比"详细分析"模块
| 维度 | 详细分析 | 持仓分布 |
|------|----------|----------|
| 视角 | AI视角（每个AI持有什么） | 股票视角（每只股票被谁持有） |
| 适用场景 | 分析单个AI的策略 | 发现市场共识和热点 |
| 数据粒度 | 单个AI的所有持仓 | 单只股票的所有持有者 |

### 信息互补
- **详细分析**：DeepSeek持有5只股票，分别是...
- **持仓分布**：AAPL被4个AI持有，分别是DeepSeek, Qwen...

---

## 🚀 后续可扩展方向

### 1. 持仓集中度指标
- 计算HHI指数（Herfindahl-Hirschman Index）
- 评估市场是否过度集中于某几只股票

### 2. 持仓变化趋势图
- 显示过去7天某股票的持有AI数量变化
- 识别"加速买入"或"加速卖出"信号

### 3. 股票相关性分析
- 被同一批AI持有的股票
- 可能存在行业相关性或策略相关性

### 4. 筛选和排序
- 按总盈亏排序
- 按持有AI数排序
- 只显示新增/清仓的股票

---

## 📝 总结

"持仓分布统计"模块通过**股票视角**，让用户快速了解：
- ✅ 市场共识（抱团股票）
- ✅ 最佳/最差标的（盈亏排行）
- ✅ 持仓变化（新增、清仓）
- ✅ 独特见解（独门股）

与"详细分析"（AI视角）互补，提供更全面的市场洞察！

