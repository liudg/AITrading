# 战报功能说明文档

## 📊 功能概述

已成功为AI交易系统添加完整的每日战报功能，采用仪表盘风格设计，侧重点清晰，信息层次分明：

- ✅ 每日战报自动生成
- ✅ 战报列表展示
- ✅ 战报详情分析（仪表盘风格）
- ✅ 模型表现对比与排名追踪
- ✅ 今日交易记录完整展示
- ✅ 持仓分布跨模型统计
- ✅ 规则引擎自动洞察生成

## 🎯 新增功能详情

### 1. 数据库模型

新增了三个数据库表：

#### `DailyReport` (每日战报)
- `day`: Day编号（Day 1, Day 2...）
- `date`: 战报日期
- `title`: 标题
- `summary`: 总结
- `overallInsight`: 整体洞察

#### `ReportModelPerformance` (模型表现详情)
- **绩效指标**：总资产、收益率、当日收益、当日收益率
- **持仓统计**：持仓数量、持仓详情、现金比例、仓位比例
- **排名追踪**：排名变化（相较昨日）
- **交易统计**：交易次数、买卖次数、胜率
- **今日交易**：当日所有交易记录（包括未平仓）
- **最佳/最差交易**：当日盈亏最高/最低的交易ID

#### `ReportStockDistribution` (持仓分布统计)
- `symbol`: 股票代码
- `holdingAICount`: 持有AI数量
- `totalShares`: 总持股数
- `totalValue`: 总市值
- `totalPnL`: 总浮盈浮亏
- `holders`: 持有者列表（JSON格式）
- `changes`: 变化列表（JSON格式：建仓/清仓）

### 2. 后端服务

#### `ReportService` (report.service.ts)
核心服务类，提供以下功能：

- **`generateDailyReport()`**: 生成每日战报
  - 自动收集所有模型的表现数据
  - 分析持仓、交易、盈亏情况
  - 生成策略分析和关键洞察
  
- **`getReportsList()`**: 获取战报列表
- **`getReportDetail()`**: 获取战报详情（通过ID）
- **`getReportByDay()`**: 获取战报详情（通过Day编号）

#### API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/reports` | GET | 获取战报列表 |
| `/api/reports/:reportId` | GET | 获取战报详情（ID） |
| `/api/reports/day/:day` | GET | 获取战报详情（Day编号） |
| `/api/reports/generate` | POST | 手动生成战报 |

#### 定时任务

在 `trading.cron.ts` 中新增每日战报生成任务：
- **执行时间**: 每天美东时间 17:00（盘后半小时）
- **配置项**: `DAILY_REPORT_CRON` 环境变量

### 3. 前端页面

#### 战报列表页面 (`/reports`)
- 展示所有战报的列表
- 按Day编号倒序排列（最新的在最上面）
- 显示：Day编号、日期、标题、摘要
- 支持手动生成今日战报
- 点击"查看详情"跳转到详情页

#### 战报详情页面 (`/reports/:id`)
采用仪表盘风格的战报分析页面，信息层次清晰：

1. **顶部快速洞察卡片区**
   - 市场概况（参与模型数、最佳/最差模型）
   - 整体洞察（重要市场信号）

2. **模型表现对比表**（核心排行榜）
   - 排名 + 排名变化（相较昨日：🔺🔻↔️）
   - 模型名称
   - 总资产、累计收益率
   - 当日盈亏（金额 + 百分比）
   - 仓位状态（现金比例/仓位比例 + 标签）
   - 持仓数、当日交易数、胜率

3. **今日交易记录**（按模型分组）
   - 显示每个模型的所有当日交易（含未平仓）
   - 按时间倒序排列
   - 标记最佳交易（🏆）和最差交易（⚠️）
   - 可折叠查看AI决策理由
   - 交易详情：股票代码、方向、数量、价格、盈亏

4. **持仓分布**（股票维度）
   - 跨模型统计每只股票的持仓情况
   - 按持有AI数量降序排列
   - 包含已清仓但当日有交易的股票
   - 展示所有持有者及其持仓量
   - 标记当日建仓/清仓的AI
   - 基于规则引擎生成的关键发现

#### 导航栏
在主导航栏添加"战报"入口，位于"排行榜"和"AI选股"之间

## 🚀 使用方法

### 方式1: 自动生成（推荐）

系统会在每天美东时间 17:00 自动生成战报。无需手动操作。

### 方式2: 生成测试数据（开发/演示用）

如果需要生成模拟的测试战报数据：

```bash
cd server
npx ts-node scripts/generate-test-report.ts
```

该脚本会：
- 创建或重置测试AI模型
- 生成模拟的交易数据（包含各种场景）
- 自动生成当日战报
- 提供完整的战报功能演示数据

### 方式3: 手动生成

1. 访问战报列表页面：`http://localhost:5173/reports`
2. 点击右上角"生成今日战报"按钮
3. 等待生成完成，自动跳转到战报详情页

### 方式4: API调用

```bash
# 生成战报
curl -X POST http://localhost:3000/api/reports/generate \
  -H "Content-Type: application/json" \
  -d '{"date": "2025-11-21"}'

# 获取战报列表
curl http://localhost:3000/api/reports

# 获取战报详情（通过ID）
curl http://localhost:3000/api/reports/{reportId}

# 获取战报详情（通过Day编号）
curl http://localhost:3000/api/reports/day/1
```

## 📝 战报内容说明

### 1. 快速洞察区
- **市场概况**：参与模型数量、表现最佳和最差的模型
- **整体洞察**：市场整体趋势、重要信号

### 2. 模型排名与表现
按累计收益率从高到低排序，前三名显示奖牌图标🥇🥈🥉

**核心指标**：
- **总资产**: 当前总市值（现金+持仓）
- **累计收益率**: 相对初始资金的累计收益率
- **当日盈亏**: 当日盈亏金额 + 当日收益率百分比
- **排名变化**: 相较昨日排名的变化（🔺上升 🔻下降 ↔️持平）
- **仓位状态**: 现金比例/仓位比例，自动标注（满仓/空仓/正常）
- **持仓数**: 当前持有的股票数量
- **当日交易数**: 当日执行的所有交易次数（含未平仓）
- **胜率**: 已平仓交易中盈利交易的占比

### 3. 今日交易记录
- **完整交易展示**：显示每个模型当日所有交易（不限数量）
- **交易状态**：包括已平仓和未平仓交易
- **时间排序**：按交易时间倒序排列
- **特殊标记**：🏆最佳交易（盈利最多）、⚠️最差交易（亏损最多）
- **决策透明**：可展开查看AI的原始决策理由
- **交易详情**：股票代码、方向（买/卖）、数量、价格、盈亏

### 4. 持仓分布（股票维度）
从股票角度统计所有AI的持仓情况：

- **统计范围**：所有在持股票 + 当日有交易的已清仓股票
- **排序规则**：按持有AI数量降序（市场共识度）
- **核心数据**：
  - 持有AI数量
  - 总持股数
  - 总浮盈浮亏
  - 主要持有者（所有持有该股的AI及持股数）
  - 当日变化（哪些AI建仓、哪些AI清仓）
- **关键发现**：基于规则引擎自动生成的洞察
  - 最受欢迎的股票（持有AI最多）
  - 当日集中建仓的股票
  - 当日集中清仓的股票
  - 存在分歧的股票（有建仓有清仓）

## 🎨 界面特色与设计理念

### 设计理念
- **仪表盘风格**：信息层次分明，关键数据一目了然
- **清晰的侧重点**：避免信息过载，突出核心指标
- **渐进式展示**：交易理由等详细信息支持折叠/展开
- **多维度视角**：既有模型维度（排名），也有股票维度（持仓分布）

### 视觉风格
- **赛博朋克风格**：科技感设计
- **颜色语义化**：
  - 绿色（`text-cyber-green`）：盈利、上涨、建仓
  - 红色（`text-cyber-red`）：亏损、下跌、清仓
  - 灰色：持平、无变化
- **卡片式布局**：各模块独立清晰
- **响应式设计**：适配各种屏幕尺寸

## 🔧 配置选项

### 环境变量

在 `server/.env` 中可配置：

```env
# 每日战报生成时间（Cron表达式）
# 默认: 0 17 * * 1-5 (每天17:00, 周一到周五)
DAILY_REPORT_CRON=0 17 * * 1-5
```

## 📊 数据示例

战报标题格式：
```
Day 1 战报：6大AI模型表现对比 • 策略分析与关键洞察
Day 2 战报：6大AI模型表现对比 • 策略分析与关键洞察
...
```

## 🐛 故障排查

### 战报列表为空
1. 检查是否有生成过战报
2. 手动点击"生成今日战报"按钮
3. 检查后端控制台是否有错误信息

### 无法生成战报
1. 确保至少有一个启用的AI模型
2. 确保模型有投资组合数据
3. 检查数据库连接是否正常

### 定时任务未执行
1. 检查 `DAILY_REPORT_CRON` 环境变量配置
2. 查看后端启动日志中的定时任务注册信息
3. 确认服务器时区设置正确

## 📈 未来扩展

可考虑的增强功能：
- **数据可视化**：添加历史收益率趋势图表
- **高级分析**：模型间的策略相似度分析
- **AI总结**：使用LLM自动生成市场总结和策略评论
- **导出功能**：导出战报为PDF或图片
- **分享功能**：战报分享到社交媒体
- **互动功能**：添加评论和讨论区
- **统计分析**：长期数据统计和回测分析
- **实时推送**：战报生成后自动推送通知

## 🎉 总结

战报功能已完整实现，包含：

### 后端实现
- ✅ 数据库模型设计（DailyReport、ReportModelPerformance、ReportStockDistribution）
- ✅ 后端服务和API（ReportService）
- ✅ 定时任务自动生成（每日盘后）
- ✅ 复杂数据聚合与计算
- ✅ 规则引擎自动洞察生成

### 前端实现
- ✅ 战报列表页面
- ✅ 仪表盘风格的战报详情页面
- ✅ 顶部快速洞察卡片区
- ✅ 模型表现对比表（含排名追踪）
- ✅ 今日交易记录完整展示
- ✅ 持仓分布跨模型统计
- ✅ 导航栏集成

### 核心特色
- ✨ **信息层次清晰**：采用仪表盘风格，避免信息过载
- ✨ **多维度视角**：模型维度 + 股票维度双重视角
- ✨ **决策透明化**：展示AI的原始决策理由
- ✨ **实时追踪**：排名变化、仓位变化、持仓变化一目了然
- ✨ **自动化洞察**：基于规则引擎自动生成关键发现

本战报系统经过多轮迭代优化，最终形成了简洁、清晰、信息密度适中的仪表盘风格设计，能够有效帮助用户快速了解AI交易系统的整体运行状况。

