# 当日交易展示功能说明

## 📋 功能概述

战报详情页的"详细分析"模块已升级，现在展示 AI 模型当日的**所有交易记录**，并智能标记最佳和最差交易。

---

## ✅ 核心特性

### 1. 完整的交易时间线 📝
- **显示所有当日交易**（不限数量）
- **包含未平仓交易**（显示浮动盈亏）
- **按时间顺序排列**（展现决策时间线）

### 2. 智能标记 🏆📉
- **最佳交易**：盈利最多的交易，标记 🏆，绿色边框
- **最差交易**：亏损最多的交易，标记 📉，红色边框
- 其他交易：灰色边框

### 3. 决策理由折叠展示 💬
- 默认折叠，节省空间
- 点击"▶ 决策理由"展开
- 再次点击"▼ 决策理由"折叠

### 4. 丰富的交易信息
每笔交易显示：
- **交易方向**：📈 买入 / 📉 卖出
- **股票代码**：AAPL, NVDA 等
- **数量和价格**：100 股 @ $500.00
- **执行时间**：14:30
- **盈亏金额**：+$500.00 (+2.3%) 或 -$200.00 (-1.5%)
- **交易状态**：已平仓 / 持仓中 / 待执行
- **决策理由**：AI 的原始思考过程

---

## 🎨 视觉效果说明

### 交易卡片布局
```
┌────────────────────────────────────────────────────┐ 绿色边框（最佳）
│ 📈 买入 NVDA  🏆 最佳                              │
│ 100股 @ $500.00  14:30                            │
│                                        +$500.00 ↗   │
│                                        (+2.3%)      │
│ ▶ 决策理由                                         │
└────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────┐ 红色边框（最差）
│ 📉 卖出 AAPL  📉 最差                              │
│ 50股 @ $270.00  15:45                             │
│                                        -$100.00 ↘   │
│                                        (-0.5%)      │
│ ▼ 决策理由                                         │
│ "技术面走弱，均线死叉，及时止损..."                │
└────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────┐ 灰色边框（普通）
│ 📈 买入 TSLA                                       │
│ 20股 @ $250.00  10:15                             │
│                                        持仓中        │
│ ▶ 决策理由                                         │
└────────────────────────────────────────────────────┘
```

---

## 📊 数据来源和计算逻辑

### 后端逻辑 (`report.service.ts`)

#### 1. 收集当日所有交易
```typescript
// 获取当日交易记录（包括未平仓）
const todayTrades = await prisma.trade.findMany({
  where: {
    modelId,
    executedAt: { gte: startOfDay, lte: endOfDay },
  },
  orderBy: { executedAt: 'asc' }, // 按时间排序
});
```

#### 2. 计算未平仓交易的浮动盈亏
```typescript
if (trade.status !== 'CLOSED' && trade.side === 'BUY') {
  const position = positions.find(p => p.symbol === trade.symbol);
  if (position) {
    pnl = (position.currentPrice - trade.price) * trade.quantity;
    pnlPct = ((position.currentPrice - trade.price) / trade.price) * 100;
  }
}
```

#### 3. 标记最佳和最差交易
```typescript
// 仅在已平仓交易中找出最佳和最差
const closedTrades = allTodayTrades.filter(t => t.status === 'CLOSED');
const sortedByPnl = closedTrades.sort((a, b) => (b.pnl || 0) - (a.pnl || 0));

bestTradeId = sortedByPnl[0]?.id;
worstTradeId = sortedByPnl[sortedByPnl.length - 1]?.id;
```

---

## 🧪 测试数据生成

### 使用方法

#### 方式1：运行批处理文件（推荐）
```bash
双击运行: 生成测试战报.bat
```

#### 方式2：命令行
```bash
cd server
npx ts-node scripts/generate-test-report.ts
```

### 测试数据特点
- 为每个 AI 模型生成 3-8 笔随机交易
- 交易时间：今天 9:30 - 16:00（美股交易时间）
- 股票池：AAPL, NVDA, TSLA, MSFT, GOOGL, META
- 70% 的交易已平仓（有盈亏），30% 持仓中
- 10 种不同的决策理由模板（真实感强）

### 生成的数据示例
```
Day 1 战报
├── DeepSeek V3: 5 笔交易
│   ├── 09:45 买入 NVDA 50股 @ $485.23  +$250.00 🏆
│   ├── 10:30 买入 AAPL 100股 @ $268.50  持仓中
│   ├── 11:15 卖出 TSLA 30股 @ $245.10  -$120.00 📉
│   ├── 14:20 买入 MSFT 80股 @ $378.90  +$150.00
│   └── 15:50 卖出 GOOGL 25股 @ $142.30  +$80.00
├── GPT-4: 4 笔交易
└── ...
```

---

## 🔄 前后对比

### 优化前
- 只显示"当日最佳"和"当日最差"两笔交易
- 看不到 AI 的完整决策过程
- 无法了解交易频率和时机

### 优化后 ✨
- 显示所有当日交易，完整的时间线
- 清晰标记最佳/最差，一目了然
- 折叠展示决策理由，既省空间又详细
- 未平仓交易也显示，能看到当前持仓来源

---

## 💡 使用场景

### 1. 分析 AI 的交易风格
- **高频交易型**：当日 10+ 笔交易
- **价值投资型**：当日 1-2 笔交易
- **波段操作型**：当日 3-5 笔交易

### 2. 学习 AI 的决策逻辑
- 展开决策理由，看 AI 如何分析
- 对比最佳和最差交易，学习何时该买/卖
- 观察未平仓交易的逻辑

### 3. 评估 AI 的交易时机
- 看 AI 在什么时间点做决策
- 是否在市场开盘/收盘时集中交易
- 是否善于抓住盘中机会

### 4. 跟踪持仓来源
- 看到"持仓中"的交易，了解当前持仓是何时建立的
- 结合决策理由，理解持仓逻辑

---

## 🎯 技术实现细节

### 数据库字段
```prisma
model ReportModelPerformance {
  todayTrades  String?  // JSON: 当日所有交易列表
  // 存储格式：
  // {
  //   trades: [...],
  //   bestTradeId: "xxx",
  //   worstTradeId: "yyy"
  // }
}
```

### 前端状态管理
```typescript
const expandedTrades = ref<Record<string, boolean>>({});

function toggleRationale(tradeId: string) {
  expandedTrades.value[tradeId] = !expandedTrades.value[tradeId];
}
```

---

## 📱 响应式设计

- **桌面端**：交易卡片清晰展示，决策理由折叠
- **平板端**：自适应布局，保持可读性
- **移动端**：堆叠显示，便于滑动查看

---

## 🚀 后续可扩展方向

### 1. 交易筛选
- 按盈亏筛选（只看盈利/亏损）
- 按股票筛选（只看某个股票）
- 按交易方向筛选（只看买入/卖出）

### 2. 统计信息
- 当日胜率
- 平均盈亏
- 最大单笔盈利/亏损

### 3. 对比模式
- 并排对比两个 AI 的当日交易
- 看谁交易更频繁
- 看谁的决策理由更充分

---

## ✅ 总结

通过本次优化，战报详情页真正做到了：

1. **信息完整**：所有当日交易一览无遗
2. **重点突出**：最佳/最差智能标记
3. **体验友好**：折叠展示，节省空间
4. **易于测试**：一键生成测试数据

用户可以像看"比赛回放"一样，完整了解 AI 当天的每一个决策！🎬

