# 测试数据脚本使用说明

## 📁 目录结构

```
server/
├── prisma/
│   └── seed.ts              # Prisma标准种子数据脚本
└── scripts/
    ├── seed-history.ts      # 生成历史快照数据
    ├── generate-test-report.ts  # 生成测试战报
    └── verify-data.ts       # 数据验证脚本
```

## 🎯 脚本功能说明

### 1. `seed.ts` - 基础种子数据

**位置**：`server/prisma/seed.ts`

**功能**：初始化数据库的基础测试数据

**创建内容**：

- ✅ 2 个 AI 模型（DeepSeek-V3, Qwen-Max）
- ✅ 2 个投资组合（每个模型一个）
- ✅ 持仓数据（各模型的股票持仓）
- ✅ 72 小时投资组合快照（用于图表展示）
- ✅ 7 条交易记录（包括已平仓和未平仓）
- ✅ 1 条反思记录
- ✅ 股票池（10 只科技股）
- ✅ 31 天市场数据（10 只股票 × 31 天）
- ✅ 10 条新闻数据
- ✅ 系统配置

**使用场景**：

- 首次初始化数据库
- 重置数据库到干净状态
- 开发环境搭建

**运行命令**：

```bash
cd server
npm run prisma:seed
```

**注意事项**：

- ⚠️ 会清空所有现有数据（包括战报）
- ⚠️ 需要先运行 `prisma migrate` 确保数据库结构最新

---

### 2. `seed-history.ts` - 历史数据生成器

**位置**：`server/scripts/seed-history.ts`

**功能**：为现有投资组合生成 72 小时的历史快照数据

**创建内容**：

- ✅ 72 小时的投资组合快照（每小时一个）
- ✅ 模拟真实的资产波动曲线
- ✅ 自动更新当前投资组合总资产

**使用场景**：

- 已有投资组合但缺少历史数据
- 重新生成历史曲线数据
- 补充快照数据用于图表展示

**运行命令**：

```bash
cd server
npm run seed:history
```

**特点**：

- 保留现有投资组合和交易数据
- 只删除并重新生成快照数据
- 模拟随机波动（-2% 到 +2%，略微上涨趋势）

---

### 3. `generate-test-report.ts` - 测试战报生成器

**位置**：`server/scripts/generate-test-report.ts`

**功能**：生成包含完整交易和战报的测试数据

**创建内容**：

- ✅ 为每个模型生成 3-8 笔随机交易
- ✅ 包含买入和卖出交易
- ✅ 包含已平仓和未平仓交易
- ✅ 真实的 AI 决策理由（从 10 条模板中随机）
- ✅ 自动生成当日战报
- ✅ 包含持仓分布统计

**使用场景**：

- 测试战报功能
- 演示战报界面
- 生成多日战报数据（多次运行）

**运行命令**：

```bash
cd server
npm run test:report
```

**特点**：

- ✅ 不需要服务器运行（直接调用服务）
- ✅ 自动计算 Day 编号
- ✅ 生成后显示访问链接
- ✅ 每次运行生成新的一天战报

**示例输出**：

```
[Test] 生成测试战报数据...
生成 Day 1 战报...
✓ DeepSeek-V3: 创建了 5 笔交易
✓ Qwen-Max: 创建了 7 笔交易
✓ Claude-3.5-Sonnet: 创建了 4 笔交易
✓ GPT-4: 创建了 6 笔交易

生成战报...
✓ 战报生成成功: Day 1
  Report ID: xxx-xxx-xxx
  包含 4 个模型的表现数据
  持仓分布: 8 只股票

✨ 访问前端查看: http://localhost:5173/reports/xxx-xxx-xxx
   或访问列表: http://localhost:5173/reports
```

---

### 4. `verify-data.ts` - 数据验证工具

**位置**：`server/scripts/verify-data.ts`

**功能**：验证数据库中所有表的数据完整性

**验证内容**：

- ✅ AI 模型数据
- ✅ 投资组合数据
- ✅ 持仓数据
- ✅ 投资组合快照
- ✅ 交易记录
- ✅ 反思记录
- ✅ 股票池
- ✅ 市场数据
- ✅ 新闻数据
- ✅ 系统配置
- ✅ **战报数据**（最新添加）

**使用场景**：

- 验证数据库初始化是否成功
- 检查数据完整性
- 调试数据问题

**运行命令**：

```bash
cd server
npm run verify
```

**示例输出**：

```
============================================================
开始验证数据库数据...
============================================================

📊 验证 AI 模型数据...
✓ 找到 4 个启用的AI模型
  - DeepSeek V3 (DeepSeek-V3)
    投资组合: 已创建
  ...

💰 验证投资组合数据...
📈 验证持仓数据...
📸 验证投资组合快照...
💼 验证交易记录...
🤔 验证反思记录...
🎯 验证股票池...
📊 验证市场数据...
📰 验证新闻数据...
⚙️  验证系统配置...

📋 验证战报数据...
✓ 找到 2 份战报
  - Day 2 (2025/11/21):
    标题: Day 2 战报：4大AI模型表现对比 • 策略分析与关键洞察
    参与模型: 4 个
    持仓分布: 6 只股票
    表现最佳: DeepSeek V3 (15.23%)

============================================================
✅ 数据验证完成！所有表都有测试数据。
============================================================
```

---

## 🚀 推荐使用流程

### 场景 1：全新项目初始化

```bash
cd server

# 1. 生成 Prisma Client
npm run prisma:generate

# 2. 运行数据库迁移
npm run prisma:migrate

# 3. 初始化种子数据
npm run prisma:seed

# 4. 验证数据
npm run verify

# 5. （可选）生成测试战报
npm run test:report
```

### 场景 2：只需要测试战报功能

```bash
cd server

# 确保已有基础数据（模型、投资组合）
# 如果没有，先运行 npm run prisma:seed

# 生成测试战报（可多次运行生成多日战报）
npm run test:report
npm run test:report  # Day 2
npm run test:report  # Day 3
```

### 场景 3：数据库重置

```bash
cd server

# 1. 重置数据库（清空所有数据）
npm run prisma:migrate reset

# 2. 重新初始化
npm run prisma:seed

# 3. 生成战报
npm run test:report
```

### 场景 4：补充历史数据

```bash
cd server

# 如果投资组合快照数据不足，重新生成72小时数据
npm run seed:history
```

---

## 📊 脚本对比

| 脚本                      | 清空数据  | 创建模型 | 创建交易 | 生成战报 | 独立运行 |
| ------------------------- | --------- | -------- | -------- | -------- | -------- |
| `seed.ts`                 | ✅ 全部   | ✅       | ✅ 少量  | ❌       | ✅       |
| `seed-history.ts`         | ⚠️ 仅快照 | ❌       | ❌       | ❌       | ✅       |
| `generate-test-report.ts` | ❌        | ❌       | ✅ 多笔  | ✅       | ✅       |
| `verify-data.ts`          | ❌        | ❌       | ❌       | ❌       | ✅       |

---

## 🔧 最近更新（2025-11-21）

### ✅ 已修正的问题

1. **seed.ts**

   - ✅ 增加战报相关表的清理（`reportStockDistribution`, `reportModelPerformance`, `dailyReport`）
   - ✅ 按依赖关系正确排序删除操作

2. **generate-test-report.ts**

   - ✅ 改用直接调用 `ReportService`，不再依赖 HTTP API
   - ✅ 可在服务器未运行时独立执行
   - ✅ 增加更详细的输出信息

3. **verify-data.ts**

   - ✅ 新增战报数据验证部分
   - ✅ 显示战报的 Day、日期、参与模型、持仓分布等信息
   - ✅ 显示表现最佳的模型

4. **package.json**
   - ✅ 新增 `test:report` 命令
   - ✅ 新增 `verify` 命令

---

## 💡 常见问题

### Q1: 运行 seed.ts 后为什么没有战报？

**A**: `seed.ts` 只创建基础数据，不生成战报。战报需要额外运行 `npm run test:report` 生成。

### Q2: 可以生成多天的战报吗？

**A**: 可以。多次运行 `npm run test:report`，每次会自动生成新的一天（Day 1, Day 2, Day 3...）。

### Q3: generate-test-report.ts 需要服务器运行吗？

**A**: 不需要。该脚本直接调用服务层代码，可独立运行。

### Q4: 如何删除测试战报？

**A**: 运行 `npm run prisma:seed` 会清空包括战报在内的所有数据。或使用 Prisma Studio 手动删除。

### Q5: 战报数据看起来不真实怎么办？

**A**: `generate-test-report.ts` 生成的是随机模拟数据。如需更真实的数据，需要让 AI 模型实际运行交易。

---

## 📝 开发建议

1. **开发环境**：使用 `seed.ts` + `test:report` 快速搭建完整演示环境
2. **测试战报功能**：使用 `test:report` 多次生成多日战报进行测试
3. **验证数据**：每次修改数据结构后运行 `verify` 确保完整性
4. **生产环境**：不要运行这些脚本，使用真实交易数据

---

## 🎯 总结

这四个脚本各司其职，配合使用可以快速搭建完整的测试环境：

- `seed.ts`：打地基（基础数据）
- `seed-history.ts`：补历史（快照数据）
- `generate-test-report.ts`：造战报（测试战报）
- `verify-data.ts`：查数据（验证完整性）

**目录结构合理**：

- ✅ `seed.ts` 在 `prisma/` - 符合 Prisma 约定
- ✅ 其他脚本在 `scripts/` - 统一管理辅助工具
